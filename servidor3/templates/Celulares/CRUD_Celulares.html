<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CRUD Celulares</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.table-fixed {
			table-layout: fixed;
			width: 100%;
		}

		.table-fixed th,
		.table-fixed td {
			overflow: hidden;
			word-break: break-word;
		}

		.table-fixed th:nth-child(1),
		.table-fixed td:nth-child(1) {
			min-width: 50px;
			width: 50px;
		}

		.table-fixed th:nth-child(2),
		.table-fixed td:nth-child(2) {
			min-width: 200px;
			width: 200px;
		}

		.table-fixed th:nth-child(3),
		.table-fixed td:nth-child(3) {
			min-width: 140px;
			width: 140px;
		}

		.table-fixed th:nth-child(4),
		.table-fixed td:nth-child(4) {
			/* Área: dar más espacio */
			min-width: 250px;
			width: 250px;
		}

		/* Departamento: aumentar ancho */
		.table-fixed th:nth-child(5),
		.table-fixed td:nth-child(5) {
			min-width: 230px;
			width: 230px;
		}

		/* Acciones: reducir ancho para botones */
		.table-fixed th:nth-child(6),
		.table-fixed td:nth-child(6) {
			min-width: 90px;
			width: 90px;
		}
	</style>
	<style>
		.table thead th {
			background: #0d3b4e;
			color: #fff;
		}

		.table tbody tr:nth-child(even) {
			background: #f2f6fa;
		}

		.btn-action {
			margin-right: 4px;
		}

		.search-box {
			max-width: 300px;
		}
	</style>
</head>

<body>
		
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
			<a class="navbar-brand" href="{{ url_for('index') }}">Celulares</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Bienvenido, {{ session.username }}</span>
                <a class="nav-link" href="{{ url_for('logout') }}">Cerrar Sesión</a>
            </div>
        </div>
    </nav>

	<div class="container mt-5">
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				<div class="container mt-3">
					{% for category, message in messages %}
						<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
							{{ message }}
							<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
						</div>
					{% endfor %}
				</div>
			{% endif %}
		{% endwith %}
		

		<!-- Encabezado mejorado: título y debajo una fila con Regresar, filtro y Agregar -->
		<div class="mb-2">
			<h2 class="mb-3">Gestión de Celulares</h2>
			<div class="row g-2 align-items-center">
				<div class="col-auto">
					<a href="/menu" class="btn btn-secondary">&larr; Regresar al menú</a>
				</div>
				<div class="col">
					<input type="text" id="filtroArea" class="form-control" placeholder="Filtrar por Área" autocomplete="off">
					<datalist id="listaAreas">
						{% set nombres_area = areas | map(attribute=1) | list %}
						{% for nombre in nombres_area | unique %}
							<option value="{{ nombre }}">{{ nombre }}</option>
						{% endfor %}
					</datalist>
				</div>
				<div class="col-auto">
					<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAgregar">+ Nuevo celular</button>
				</div>
			</div>
		</div>
		<!-- Modal para editar celular -->
		<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form id="formEditar" method="POST">
						<div class="modal-header">
							<h5 class="modal-title" id="modalEditarLabel">Editar Celular</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id" id="editarId">
							<div class="mb-3">
								<label for="editarNombre" class="form-label">Nombre</label>
								<input list="listaColaboradoresEditar" class="form-control" id="editarNombre" required autocomplete="off">
								<datalist id="listaColaboradoresEditar">
									{% for col in colaboradores_info %}
										<option value="{{ col.nombre }}" data-id="{{ col.id }}">{{ col.nombre }}</option>
									{% endfor %}
								</datalist>
								<input type="hidden" name="id_colaborador" id="editarIdColaborador">
							</div>
							<div class="mb-3">
								<label for="editarCelular" class="form-label">Celular</label>
								<input type="number" class="form-control" name="celular" id="editarCelular" required>
							</div>
							<div class="mb-3">
								<label for="editarArea" class="form-label">Área</label>
								<select class="form-select" id="editarArea" required disabled>
									<option value="">Seleccione un área</option>
									{% for a in areas %}
										<option value="{{ a[0] }}">{{ a[1] }}</option>
									{% endfor %}
								</select>
								<input type="hidden" name="area" id="editarAreaHidden">
							</div>
							<div class="mb-3">
								<label for="editarDepartamento" class="form-label">Departamento</label>
								<select class="form-select" id="editarDepartamento" required disabled>
									<option value="">Seleccione un departamento</option>
									{% for d in departamentos %}
										<option value="{{ d[0] }}">{{ d[1] }}</option>
									{% endfor %}
								</select>
								<input type="hidden" name="departamento" id="editarDepartamentoHidden">
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Guardar cambios</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Modales reubicados para compatibilidad Bootstrap -->
		<!-- Modal para agregar celular -->
		<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form method="POST" action="{{ url_for('crud_celulares') }}">
						<div class="modal-header">
							<h5 class="modal-title" id="modalAgregarLabel">Agregar Celular</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="mb-3">
								<label for="nuevoNombre" class="form-label">Nombre</label>
								<input list="listaColaboradoresNuevo" class="form-control" id="nuevoNombre" required autocomplete="off">
								<datalist id="listaColaboradoresNuevo">
									{% for col in colaboradores_info %}
										<option value="{{ col.nombre }}" data-id="{{ col.id }}">{{ col.nombre }}</option>
									{% endfor %}
								</datalist>
								<input type="hidden" name="id_colaborador" id="nuevoIdColaborador">
								<script>
								// Filtrado dinámico de datalist por coincidencia parcial para el campo Nombre
								document.addEventListener('DOMContentLoaded', function() {
									var input = document.getElementById('nuevoNombre');
									var datalist = document.getElementById('listaColaboradores');
									var allOptions = Array.from(datalist.options).map(opt => opt.value);
									function renderOptions(val) {
										datalist.innerHTML = '';
										if (!val) {
											allOptions.forEach(function(nombre) {
												var opt = document.createElement('option');
												opt.value = nombre;
												datalist.appendChild(opt);
											});
										} else {
											allOptions.forEach(function(nombre) {
												if (nombre.toLowerCase().includes(val)) {
													var opt = document.createElement('option');
													opt.value = nombre;
													datalist.appendChild(opt);
												}
											});
										}
									}
									// Inicializar con todas las opciones
									renderOptions('');
									input.addEventListener('input', function() {
										var val = input.value.trim().toLowerCase();
										renderOptions(val);
									});
									// También restaurar si el input queda vacío por otros medios
									input.addEventListener('change', function() {
										if (!input.value.trim()) renderOptions('');
									});
									input.addEventListener('blur', function() {
										if (!input.value.trim()) renderOptions('');
									});
								});
								</script>
							</div>
							<div class="mb-3">
								<label for="nuevoCelular" class="form-label">Celular</label>
								<input type="number" class="form-control" name="celular" id="nuevoCelular" required>
							</div>
							<div class="mb-3">
								<label for="nuevaArea" class="form-label">Área</label>
								<select class="form-select" id="nuevaArea" required disabled>
									<option value="">Seleccione un área</option>
								</select>
								<input type="hidden" name="area" id="nuevaAreaHidden">
							</div>
							<div class="mb-3">
								<label for="nuevoDepartamento" class="form-label">Departamento</label>
								<select class="form-select" id="nuevoDepartamento" required disabled>
									<option value="">Seleccione un departamento</option>
								</select>
								<input type="hidden" name="departamento" id="nuevoDepartamentoHidden">
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Agregar</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Modal para editar departamento -->
		<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form id="formEditar" method="POST">
						<div class="modal-header">
							<h5 class="modal-title" id="modalEditarLabel">Editar Departamento</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id" id="editarId">
							<div class="mb-3">
								<label for="editarDepartamento" class="form-label">Departamento</label>
								<input type="text" class="form-control" name="departamento" id="editarDepartamento"
									required>
							</div>
							<div class="mb-3">
								<label for="editarDescripcion" class="form-label">Descripción</label>
								<input type="text" class="form-control" name="descripcion" id="editarDescripcion"
									required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Guardar cambios</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Header consolidated above: título + fila con Regresar, filtro y Agregar -->
		<table class="table table-bordered table-fixed" id="tablaCelulares">
			<thead>
				<tr>
					<th>ID</th>
					<th>Nombre</th>
					<th>Celular</th>
					<th>Área</th>
					<th>Departamento</th>
					<th>Acciones</th>
				</tr>
			</thead>
			<tbody>
				{% for cel in celulares %}
				<tr>
					<td>{{ cel[0] }}</td>
					<td class="cel-nombre">{{ cel[1] }}</td>
					<td class="cel-celular">{{ cel[2] }}</td>
					<td class="cel-area" data-area-id="{{ cel[5] }}">{{ cel[3] }}</td>
					<td class="cel-departamento" data-dep-id="{{ cel[6] }}">{{ cel[4] }}</td>
					<td>
						<button type="button" class="btn btn-sm btn-primary btn-action" title="Editar"
							data-bs-toggle="modal" data-bs-target="#modalEditar"
							data-id="{{ cel[0] }}"
							data-nombre="{{ cel[1]|e }}"
							data-celular="{{ cel[2] }}"
							data-area-id="{{ cel[5] }}"
							data-dep-id="{{ cel[6] }}"
							onclick="llenarFormularioEditarDesdeBoton(this)">
							<i class="bi bi-pencil"></i>
						</button>
						<form method="POST" action="{{ url_for('eliminar_celular', id=cel[0]) }}" class="d-inline">
							<button type="submit" class="btn btn-sm btn-danger btn-action" title="Eliminar"><i class="bi bi-trash"></i></button>
						</form>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<script>
		// Mapeo de colaboradores a área y departamento (relleno desde backend)
		   const colaboradoresInfo = [
			   {% for col in colaboradores_info %}
			   {
				   id: "{{ col.id }}",
				   nombre: "{{ col.nombre|e }}",
				   area: {id: "{{ col.area_id }}", nombre: "{{ col.area_nombre|e }}"},
				   departamento: {id: "{{ col.departamento_id }}", nombre: "{{ col.departamento_nombre|e }}"}
			   }{% if not loop.last %},{% endif %}
			   {% endfor %}
		   ];

		document.getElementById('nuevoNombre').addEventListener('input', function() {
			const nombre = this.value;
			const col = colaboradoresInfo.find(c => c.nombre === nombre);
			const areaSelect = document.getElementById('nuevaArea');
			const depSelect = document.getElementById('nuevoDepartamento');
			const areaHidden = document.getElementById('nuevaAreaHidden');
			const depHidden = document.getElementById('nuevoDepartamentoHidden');
			const idColaboradorHidden = document.getElementById('nuevoIdColaborador');
			areaSelect.innerHTML = '<option value="">Seleccione un área</option>';
			depSelect.innerHTML = '<option value="">Seleccione un departamento</option>';
			if (col) {
				areaSelect.innerHTML += `<option value="${col.area.id}" selected>${col.area.nombre}</option>`;
				depSelect.innerHTML += `<option value="${col.departamento.id}" selected>${col.departamento.nombre}</option>`;
				if (areaHidden) areaHidden.value = col.area.id;
				if (depHidden) depHidden.value = col.departamento.id;
				if (idColaboradorHidden) idColaboradorHidden.value = col.id;
			} else {
				if (areaHidden) areaHidden.value = '';
				if (depHidden) depHidden.value = '';
				if (idColaboradorHidden) idColaboradorHidden.value = '';
			}
		});
		// Sincronizar campos ocultos al abrir el modal de agregar
		var modalAgregar = document.getElementById('modalAgregar');
		if (modalAgregar) {
			modalAgregar.addEventListener('show.bs.modal', function() {
				var areaHidden = document.getElementById('nuevaAreaHidden');
				var depHidden = document.getElementById('nuevoDepartamentoHidden');
				var areaSelect = document.getElementById('nuevaArea');
				var depSelect = document.getElementById('nuevoDepartamento');
				if (areaHidden && areaSelect) areaHidden.value = areaSelect.value;
				if (depHidden && depSelect) depHidden.value = depSelect.value;
			});
		}
		// Sincronizar SIEMPRE justo antes de enviar el formulario de agregar
		var formNuevo = document.querySelector('form[action="{{ url_for('crud_celulares') }}"]');
		if (formNuevo) {
			formNuevo.addEventListener('submit', function(e) {
				var areaHidden = document.getElementById('nuevaAreaHidden');
				var depHidden = document.getElementById('nuevoDepartamentoHidden');
				var areaSelect = document.getElementById('nuevaArea');
				var depSelect = document.getElementById('nuevoDepartamento');
				if (areaHidden && areaSelect) areaHidden.value = areaSelect.value;
				if (depHidden && depSelect) depHidden.value = depSelect.value;
			}, true);
		}
		function llenarFormularioEditarDesdeBoton(btn) {
			var id = btn.getAttribute('data-id');
			var nombre = btn.getAttribute('data-nombre');
			var celular = btn.getAttribute('data-celular');
			var areaId = btn.getAttribute('data-area-id');
			var depId = btn.getAttribute('data-dep-id');
			document.getElementById('formEditar').action = '/celulares/editar/' + id;
			document.getElementById('editarId').value = id;
			document.getElementById('editarNombre').value = nombre;
			document.getElementById('editarCelular').value = celular;
			document.getElementById('editarArea').value = areaId;
			document.getElementById('editarDepartamento').value = depId;
			// Sincronizar campos ocultos
			var areaHidden = document.getElementById('editarAreaHidden');
			var depHidden = document.getElementById('editarDepartamentoHidden');
			if (areaHidden) areaHidden.value = areaId;
			if (depHidden) depHidden.value = depId;
		}

		// Autocompletar área y departamento al cambiar el nombre en editar
		document.getElementById('editarNombre').addEventListener('input', function() {
			const nombre = this.value;
			const col = colaboradoresInfo.find(c => c.nombre === nombre);
			const areaSelect = document.getElementById('editarArea');
			const depSelect = document.getElementById('editarDepartamento');
			const areaHidden = document.getElementById('editarAreaHidden');
			const depHidden = document.getElementById('editarDepartamentoHidden');
			areaSelect.innerHTML = '<option value="">Seleccione un área</option>';
			depSelect.innerHTML = '<option value="">Seleccione un departamento</option>';
			if (col) {
				areaSelect.innerHTML += `<option value="${col.area.id}" selected>${col.area.nombre}</option>`;
				depSelect.innerHTML += `<option value="${col.departamento.id}" selected>${col.departamento.nombre}</option>`;
				if (areaHidden) areaHidden.value = col.area.id;
				if (depHidden) depHidden.value = col.departamento.id;
			} else {
				if (areaHidden) areaHidden.value = '';
				if (depHidden) depHidden.value = '';
			}
		});
		// Sincronizar campos ocultos al abrir el modal de editar
		var modalEditar = document.getElementById('modalEditar');
		if (modalEditar) {
			modalEditar.addEventListener('show.bs.modal', function() {
				var areaHidden = document.getElementById('editarAreaHidden');
				var depHidden = document.getElementById('editarDepartamentoHidden');
				var areaSelect = document.getElementById('editarArea');
				var depSelect = document.getElementById('editarDepartamento');
				if (areaHidden && areaSelect) areaHidden.value = areaSelect.value;
				if (depHidden && depSelect) depHidden.value = depSelect.value;
			});
		}
		// Sincronizar SIEMPRE justo antes de enviar el formulario de editar
		var formEditar = document.getElementById('formEditar');
		if (formEditar) {
			formEditar.addEventListener('submit', function(e) {
				var idColaboradorHidden = document.getElementById('editarIdColaborador');
				var nombreInput = document.getElementById('editarNombre');
				var col = colaboradoresInfo.find(c => c.nombre === nombreInput.value);
				if (col && idColaboradorHidden) {
					idColaboradorHidden.value = col.id;
				} else if (idColaboradorHidden) {
					e.preventDefault();
					idColaboradorHidden.value = '';
					alert('Debes seleccionar un colaborador válido.');
					return;
				}
				var areaHidden = document.getElementById('editarAreaHidden');
				var depHidden = document.getElementById('editarDepartamentoHidden');
				var areaSelect = document.getElementById('editarArea');
				var depSelect = document.getElementById('editarDepartamento');
				if (areaHidden && areaSelect) areaHidden.value = areaSelect.value;
				if (depHidden && depSelect) depHidden.value = depSelect.value;
			}, true);
		}
		function filtrarPorArea() {
			var valor = document.getElementById('filtroArea').value.trim().toLowerCase();
			var tabla = document.getElementById('tablaCelulares');
			var filas = tabla.getElementsByTagName('tr');
			for (var i = 1; i < filas.length; i++) { // i=1 para saltar el encabezado
				var celda = filas[i].getElementsByClassName('cel-area')[0];
				if (celda) {
					var texto = celda.textContent.trim().toLowerCase();
					if (!valor || texto.includes(valor)) {
						filas[i].style.display = '';
					} else {
						filas[i].style.display = 'none';
					}
				}
			}
		}
		// Conectar input para filtrado en tiempo real
		document.addEventListener('DOMContentLoaded', function() {
			var inputFiltro = document.getElementById('filtroArea');
			if (inputFiltro) {
				inputFiltro.setAttribute('list', 'listaAreas');
				inputFiltro.addEventListener('input', filtrarPorArea);
			}
		});
		document.addEventListener('DOMContentLoaded', function() {
    // --- Lógica para el formulario de AGREGAR ---
    var inputNuevo = document.getElementById('nuevoNombre');
    var datalistNuevo = document.getElementById('listaColaboradoresNuevo');
    var allOptionsNuevo = Array.from(datalistNuevo.options).map(opt => opt.value);
    function renderOptionsNuevo(val) {
        datalistNuevo.innerHTML = '';
        if (!val) {
            allOptionsNuevo.forEach(function(nombre) {
                var opt = document.createElement('option');
                opt.value = nombre;
                datalistNuevo.appendChild(opt);
            });
        } else {
            allOptionsNuevo.forEach(function(nombre) {
                if (nombre.toLowerCase().includes(val)) {
                    var opt = document.createElement('option');
                    opt.value = nombre;
                    datalistNuevo.appendChild(opt);
                }
            });
        }
    }
    renderOptionsNuevo('');
    inputNuevo.addEventListener('input', function() {
        var val = inputNuevo.value.trim().toLowerCase();
        renderOptionsNuevo(val);
        // Sincronizar ID_COLABORADOR
        var col = colaboradoresInfo.find(c => c.nombre === inputNuevo.value);
        var idColaboradorHidden = document.getElementById('nuevoIdColaborador');
        if (col && idColaboradorHidden) {
            idColaboradorHidden.value = col.id;
        } else if (idColaboradorHidden) {
            idColaboradorHidden.value = '';
        }
    });
    inputNuevo.addEventListener('change', function() {
        if (!inputNuevo.value.trim()) renderOptionsNuevo('');
    });
    inputNuevo.addEventListener('blur', function() {
        if (!inputNuevo.value.trim()) renderOptionsNuevo('');
    });

    // --- Lógica para el formulario de EDITAR ---
    var inputEditar = document.getElementById('editarNombre');
    var datalistEditar = document.getElementById('listaColaboradoresEditar');
    var allOptionsEditar = Array.from(datalistEditar.options).map(opt => opt.value);
    function renderOptionsEditar(val) {
        datalistEditar.innerHTML = '';
        if (!val) {
            allOptionsEditar.forEach(function(nombre) {
                var opt = document.createElement('option');
                opt.value = nombre;
                datalistEditar.appendChild(opt);
            });
        } else {
            allOptionsEditar.forEach(function(nombre) {
                if (nombre.toLowerCase().includes(val)) {
                    var opt = document.createElement('option');
                    opt.value = nombre;
                    datalistEditar.appendChild(opt);
                }
            });
        }
    }
    renderOptionsEditar('');
    inputEditar.addEventListener('input', function() {
        var val = inputEditar.value.trim().toLowerCase();
        renderOptionsEditar(val);
        // Sincronizar ID_COLABORADOR
        var col = colaboradoresInfo.find(c => c.nombre === inputEditar.value);
        var idColaboradorHidden = document.getElementById('editarIdColaborador');
        if (col && idColaboradorHidden) {
            idColaboradorHidden.value = col.id;
        } else if (idColaboradorHidden) {
            idColaboradorHidden.value = '';
        }
    });
    inputEditar.addEventListener('change', function() {
        if (!inputEditar.value.trim()) renderOptionsEditar('');
    });
    inputEditar.addEventListener('blur', function() {
        if (!inputEditar.value.trim()) renderOptionsEditar('');
    });
});
	</script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>