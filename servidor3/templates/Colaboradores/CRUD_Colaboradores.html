<script>
		// Inyectar cargos_info desde backend correctamente como JS
		window.cargos_info = {{ cargos_info|tojson|safe }};
		document.addEventListener('DOMContentLoaded', function() {
			var inputCargo = document.getElementById('nuevoCargo');
			var selectArea = document.getElementById('nuevaArea');
			var selectDep = document.getElementById('nuevoDepartamento');
			inputCargo.addEventListener('input', function() {
				var cargoNombre = inputCargo.value.trim().toLowerCase();
				var cargo = window.cargos_info.find(function(c) {
					return c.nombre.toLowerCase() === cargoNombre;
				});
				if (cargo) {
					// Seleccionar área
					for (var i = 0; i < selectArea.options.length; i++) {
						if (selectArea.options[i].value == cargo.area) {
							selectArea.selectedIndex = i;
							break;
						}
					}
					// Seleccionar departamento
					for (var j = 0; j < selectDep.options.length; j++) {
						if (selectDep.options[j].value == cargo.departamento) {
							selectDep.selectedIndex = j;
							break;
						}
					}
				}
			});
		});
		</script>
<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CRUD Colaboradores</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.table-fixed {
			table-layout: fixed;
			width: 100%;
		}

		.table-fixed th,
		.table-fixed td {
			overflow: hidden;
			word-break: break-word;
		}

		.table-fixed th:nth-child(1),
		.table-fixed td:nth-child(1) {
			min-width: 50px;
			width: 50px;
		}

		.table-fixed th:nth-child(2),
		.table-fixed td:nth-child(2) {
			min-width: 220px;
			width: 220px;
		}

		.table-fixed th:nth-child(3),
		.table-fixed td:nth-child(3) {
			min-width: 200px;
			width: 200px;
		}

		.table-fixed th:nth-child(4),
		.table-fixed td:nth-child(4) {
			min-width: 150px;
			width: 150px;
		}

		/* Columnas adicionales: Cargo, Ubicación, Acciones */
		.table-fixed th:nth-child(5),
		.table-fixed td:nth-child(5) {
			min-width: 180px;
			width: 180px;
		}

		.table-fixed th:nth-child(6),
		.table-fixed td:nth-child(6) {
			min-width: 140px;
			width: 140px;
		}

		.table-fixed th:nth-child(7),
		.table-fixed td:nth-child(7) {
			min-width: 90px;
			width: 90px;
		}
	</style>
	<style>
		.table thead th {
			background: #0d3b4e;
			color: #fff;
		}

		.table tbody tr:nth-child(even) {
			background: #f2f6fa;
		}

		.btn-action {
			margin-right: 4px;
		}

		.search-box {
			max-width: 300px;
		}
	</style>
</head>

<body>
	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
			<a class="navbar-brand" href="{{ url_for('index') }}">Colaboradores</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Bienvenido, {{ session.username }}</span>
                <a class="nav-link" href="{{ url_for('logout') }}">Cerrar Sesión</a>
            </div>
        </div>
    </nav>

	<div class="container mt-5">
		<!-- Alerta de éxito al agregar colaborador -->
		<div id="alertaExito" class="alert alert-success alert-dismissible fade show" role="alert" style="display:none;">
			Colaborador agregado exitosamente.
			<button type="button" class="btn-close" onclick="cerrarAlertaExito()" aria-label="Close"></button>
		</div>
		<!-- Alerta de error de validación -->
		<div id="alertaError" class="alert alert-danger alert-dismissible fade show" role="alert" style="display:none;">
			<span id="textoAlertaError"></span>
			<button type="button" class="btn-close" onclick="cerrarAlertaError()" aria-label="Close"></button>
		</div>
		{% with messages = get_flashed_messages(with_categories=true) %}
		  {% if messages %}
		    <div class="container mt-3">
		      {% for category, message in messages %}
		        {% if category == 'danger' %}
		          <div class="alert alert-danger alert-dismissible fade show" role="alert">
		            {{ message }}
		            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		          </div>
		        {% endif %}
		      {% endfor %}
		    </div>
		  {% endif %}
		{% endwith %}
		<div class="d-flex justify-content-between align-items-center mb-3">
			<a href="/menu" class="btn btn-secondary">&larr; Regresar al menú</a>
			<div class="ms-3" style="min-width:350px; max-width:500px; width:100%;">
				<select id="selectArea" class="form-select" onchange="filtrarPorArea()">
					<option value="">-- Todas las áreas --</option>
					{% set nombres_area = areas | map(attribute=1) | list %}
					{% for nombre in nombres_area | unique %}
					<option value="{{ nombre }}">{{ nombre }}</option>
					{% endfor %}
				</select>
			</div>
		</div>
		<!-- Modal para editar colaborador -->
		<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form id="formEditar" method="POST">
						<div class="modal-header">
							<h5 class="modal-title" id="modalEditarLabel">Editar Colaborador</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id" id="editarId">
							<div class="mb-3">
								<label for="editarNombre" class="form-label">Nombre y Apellido</label>
								<input type="text" class="form-control" name="nombre" id="editarNombre" required placeholder="Ejemplo: Juan Pérez">
							</div>
							<div class="mb-3">
								<label for="editarArea" class="form-label">Área</label>
								<select class="form-select" id="editarArea" required disabled>
									<option value="">Seleccione un área</option>
									{% for a in areas %}
										<option value="{{ a[0] }}">{{ a[1] }}</option>
									{% endfor %}
								</select>
								<input type="hidden" name="area" id="editarAreaHidden">
							</div>
							<div class="mb-3">
								<label for="editarDepartamento" class="form-label">Departamento</label>
								<select class="form-select" id="editarDepartamento" required disabled>
									<option value="">Seleccione un departamento</option>
									{% for d in departamentos %}
										<option value="{{ d[0] }}">{{ d[1] }}</option>
									{% endfor %}
								</select>
								<input type="hidden" name="departamento" id="editarDepartamentoHidden">
							</div>
							<div class="mb-3">
								<label for="editarCargo" class="form-label">Cargo</label>
								<input class="form-control" list="listaCargos" name="cargo" id="editarCargo" required placeholder="Buscar y seleccionar cargo...">
								<datalist id="listaCargos">
									{% for c in cargos %}
										<option value="{{ c[1] }}" data-id="{{ c[0] }}"></option>
									{% endfor %}
								</datalist>
							</div>
							<div class="mb-3">
								<label for="editarUbicacion" class="form-label">Ubicación</label>
								<select class="form-select" name="ubicacion" id="editarUbicacion" required>
									<option value="">Seleccione una ubicación</option>
									{% for u in ubicaciones %}
										<option value="{{ u[0] }}">{{ u[1] }}</option>
									{% endfor %}
								</select>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Guardar cambios</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Modales reubicados para compatibilidad Bootstrap -->
		<!-- Modal para agregar colaborador -->
		<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form method="POST" action="{{ url_for('crud_colaboradores') }}" id="formNuevoColaborador">
<script>
// Al enviar el formulario, convertir el nombre del cargo en su ID y mostrar alerta de error si el nombre es solo números
// El backend se encargará de mostrar el mensaje de éxito y recargar la tabla
// Eliminar la lógica de mostrar mensaje de éxito y resetear el formulario desde JS

document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('formNuevoColaborador');
    if (form) {
        form.addEventListener('submit', function(e) {
            var inputCargo = document.getElementById('nuevoCargo');
            var cargoNombre = inputCargo.value.trim().toLowerCase();
            var cargo = (window.cargos_info || []).find(function(c) {
                return c.nombre.toLowerCase() === cargoNombre;
            });
            if (cargo) {
                inputCargo.value = cargo.id;
            } else {
                // Si no se encuentra, limpiar para forzar error de validación en backend
                inputCargo.value = '';
            }

            // Validación de nombre: no puede ser solo números
            var nombre = document.getElementById('nuevoNombre').value.trim();
            var soloNumeros = /^\d+$/.test(nombre);
            if (soloNumeros) {
                e.preventDefault();
                mostrarAlertaError('El nombre del colaborador no puede ser solo números.');
                return;
            }
            // El resto de validaciones y mensajes los maneja el backend
        });
    }
});

function mostrarAlertaError(mensaje) {
    var alerta = document.getElementById('alertaError');
    var texto = document.getElementById('textoAlertaError');
    texto.textContent = mensaje;
    alerta.style.display = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
function cerrarAlertaError() {
    document.getElementById('alertaError').style.display = 'none';
}
function cerrarAlertaExito() {
    document.getElementById('alertaExito').style.display = 'none';
}
</script>
						<div class="modal-header">
							<h5 class="modal-title" id="modalAgregarLabel">Agregar Colaborador</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="mb-3">
								<label for="nuevoNombre" class="form-label">Nombre y Apellido</label>
								<input type="text" class="form-control" name="nombre" id="nuevoNombre" required placeholder="Ejemplo: Juan Pérez">
							</div>
							<div class="mb-3">
								<label for="nuevaArea" class="form-label">Área</label>
								<select class="form-select" name="area_disabled" id="nuevaArea" required disabled>
									<option value="">Seleccione un área</option>
									{% for a in areas %}
										<option value="{{ a[0] }}">{{ a[1] }}</option>
									{% endfor %}
								</select>
								<input type="hidden" name="area" id="nuevaAreaHidden">
							</div>
							<div class="mb-3">
								<label for="nuevoDepartamento" class="form-label">Departamento</label>
								<select class="form-select" name="departamento_disabled" id="nuevoDepartamento" required disabled>
									<option value="">Seleccione un departamento</option>
									{% for d in departamentos %}
										<option value="{{ d[0] }}">{{ d[1] }}</option>
									{% endfor %}
								</select>
								<input type="hidden" name="departamento" id="nuevoDepartamentoHidden">
							</div>
		<script>
		// cargos_info debe ser inyectado desde el backend como un objeto JS
		// Ejemplo: var cargos_info = [{id: 1, nombre: 'Cargo1', area: 2, departamento: 3}, ...];
		// Aquí se asume que se inyecta correctamente antes de este script
		document.addEventListener('DOMContentLoaded', function() {
			// Para agregar colaborador
			var inputCargo = document.getElementById('nuevoCargo');
			var selectArea = document.getElementById('nuevaArea');
			var selectDep = document.getElementById('nuevoDepartamento');
			var areaHidden = document.getElementById('nuevaAreaHidden');
			var depHidden = document.getElementById('nuevoDepartamentoHidden');
			function syncHiddenFields() {
				areaHidden.value = selectArea.value;
				depHidden.value = selectDep.value;
			}
			// Sincronizar al cambiar cargo
			var inputCargo = document.getElementById('nuevoCargo');
			if (inputCargo) {
				inputCargo.addEventListener('input', function() {
					var cargoNombre = inputCargo.value.trim().toLowerCase();
					var cargo = cargos_info.find(function(c) {
						return c.nombre.toLowerCase() === cargoNombre;
					});
					if (cargo) {
						// Seleccionar área
						for (var i = 0; i < selectArea.options.length; i++) {
							if (selectArea.options[i].value == cargo.area) {
								selectArea.selectedIndex = i;
								break;
							}
						}
						// Seleccionar departamento
						for (var j = 0; j < selectDep.options.length; j++) {
							if (selectDep.options[j].value == cargo.departamento) {
								selectDep.selectedIndex = j;
								break;
							}
						}
						syncHiddenFields();
					}
				});
			}
			// Sincronizar al abrir el modal
			var modalAgregar = document.getElementById('modalAgregar');
			if (modalAgregar) {
				modalAgregar.addEventListener('show.bs.modal', syncHiddenFields);
			}
			// Sincronizar SIEMPRE justo antes de enviar el formulario
			var form = document.getElementById('formNuevoColaborador');
			if (form) {
				form.addEventListener('submit', function(e) {
					syncHiddenFields();
				}, true); // true para que se ejecute antes de otros listeners
			}
		});
		</script>
							<div class="mb-3">
								<label for="nuevoCargo" class="form-label">Cargo</label>
								<input class="form-control" list="listaCargos" name="cargo" id="nuevoCargo" required placeholder="Buscar y seleccionar cargo...">
								<datalist id="listaCargos">
									{% for c in cargos %}
										<option value="{{ c[1] }}" data-id="{{ c[0] }}"></option>
									{% endfor %}
								</datalist>
							</div>
							<div class="mb-3">
								<label for="nuevaUbicacion" class="form-label">Ubicación</label>
								<select class="form-select" name="ubicacion" id="nuevaUbicacion" required>
									<option value="">Seleccione una ubicación</option>
									{% for u in ubicaciones %}
										<option value="{{ u[0] }}">{{ u[1] }}</option>
									{% endfor %}
								</select>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Agregar</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Modal para editar departamento -->
		<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form id="formEditar" method="POST">
						<div class="modal-header">
							<h5 class="modal-title" id="modalEditarLabel">Editar Departamento</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id" id="editarId">
							<div class="mb-3">
								<label for="editarDepartamento" class="form-label">Departamento</label>
								<input type="text" class="form-control" name="departamento" id="editarDepartamento"
									required>
							</div>
							<div class="mb-3">
								<label for="editarDescripcion" class="form-label">Descripción</label>
								<input type="text" class="form-control" name="descripcion" id="editarDescripcion"
									required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Guardar cambios</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="d-flex justify-content-between align-items-center mb-3">
			<h2>Gestión de Colaboradores</h2>
			<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAgregar">+ Nuevo colaborador</button>
		</div>
		<table class="table table-bordered table-fixed" id="tablaColaboradores">
			<thead>
				<tr>
					<th>ID</th>
					<th>Nombre</th>
					<th>Área</th>
					<th>Departamento</th>
					<th>Cargo</th>
					<th>Ubicación</th>
					<th>Acciones</th>
				</tr>
			</thead>
			<tbody>
				{% for col in colaboradores %}
				<tr>
					<td>{{ col[0] }}</td>
					<td class="col-nombre">{{ col[1] }}</td>
					<td class="col-area" data-area-id="{{ col[7] }}">{{ col[3] }}</td>
					<td class="col-departamento" data-dep-id="{{ col[6] }}">{{ col[2] }}</td>
					<td class="col-cargo" data-cargo-id="{{ col[8] }}">{{ col[4] }}</td>
					<td class="col-ubicacion" data-ubicacion-id="{{ col[9] }}">{{ col[5] }}</td>
					<td>
						<button type="button" class="btn btn-sm btn-primary btn-action" title="Editar"
							data-bs-toggle="modal" data-bs-target="#modalEditar"
							data-id="{{ col[0] }}"
							data-nombre="{{ col[1]|e }}"
							data-area-id="{{ col[7] }}"
							data-dep-id="{{ col[6] }}"
							data-cargo-id="{{ col[8] }}"
							data-ubicacion-id="{{ col[9] }}"
							onclick="llenarFormularioEditarDesdeBoton(this)">
							<i class="bi bi-pencil"></i>
						</button>
						<form method="POST" action="{{ url_for('eliminar_colaborador', id=col[0]) }}" class="d-inline">
							<button type="submit" class="btn btn-sm btn-danger btn-action" title="Eliminar"><i class="bi bi-trash"></i></button>
						</form>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<script>
		function llenarFormularioEditarDesdeBoton(btn) {
			var id = btn.getAttribute('data-id');
			var nombre = btn.getAttribute('data-nombre');
			var areaId = btn.getAttribute('data-area-id');
			var depId = btn.getAttribute('data-dep-id');
			var cargoId = btn.getAttribute('data-cargo-id');
			var ubicacionId = btn.getAttribute('data-ubicacion-id');
			document.getElementById('formEditar').action = '/crud_colaboradores/editar/' + id;
			document.getElementById('editarId').value = id;
			document.getElementById('editarNombre').value = nombre;
			document.getElementById('editarArea').value = areaId;
			document.getElementById('editarDepartamento').value = depId;
			// Buscar el nombre del cargo por su id en el datalist
			var cargoNombre = '';
			var opciones = document.querySelectorAll('#listaCargos option');
			opciones.forEach(function(opt) {
				if(opt.getAttribute('data-id') == cargoId) {
					cargoNombre = opt.value;
				}
			});
			document.getElementById('editarCargo').value = cargoNombre;
			document.getElementById('editarUbicacion').value = ubicacionId;
		}
		function filtrarPorArea() {
			var select = document.getElementById('selectArea');
			var valor = select.value;
			var tabla = document.getElementById('tablaColaboradores');
			var filas = tabla.getElementsByTagName('tr');
			for (var i = 1; i < filas.length; i++) { // i=1 para saltar el encabezado
				var celda = filas[i].getElementsByClassName('col-area')[0];
				if (celda) {
					if (valor === "" || celda.textContent.trim() === valor) {
						filas[i].style.display = '';
					} else {
						filas[i].style.display = 'none';
					}
				}
			}
		}
	</script>
<script>
// --- Lógica para autocompletar área y departamento en el modal de edición ---
document.addEventListener('DOMContentLoaded', function() {
	var inputCargoEdit = document.getElementById('editarCargo');
	var selectAreaEdit = document.getElementById('editarArea');
	var selectDepEdit = document.getElementById('editarDepartamento');
	var areaHiddenEdit = document.getElementById('editarAreaHidden');
	var depHiddenEdit = document.getElementById('editarDepartamentoHidden');

	function syncHiddenFieldsEdit() {
		if (areaHiddenEdit && selectAreaEdit) areaHiddenEdit.value = selectAreaEdit.value;
		if (depHiddenEdit && selectDepEdit) depHiddenEdit.value = selectDepEdit.value;
	}

	if (inputCargoEdit) {
		inputCargoEdit.addEventListener('input', function() {
			var cargoNombre = inputCargoEdit.value.trim().toLowerCase();
			var cargo = (window.cargos_info || []).find(function(c) {
				return c.nombre.toLowerCase() === cargoNombre;
			});
			if (cargo) {
				// Seleccionar área
				for (var i = 0; i < selectAreaEdit.options.length; i++) {
					if (selectAreaEdit.options[i].value == cargo.area) {
						selectAreaEdit.selectedIndex = i;
						break;
					}
				}
				// Seleccionar departamento
				for (var j = 0; j < selectDepEdit.options.length; j++) {
					if (selectDepEdit.options[j].value == cargo.departamento) {
						selectDepEdit.selectedIndex = j;
						break;
					}
				}
				syncHiddenFieldsEdit();
			}
		});
	}
	// Sincronizar campos ocultos al abrir el modal de edición
	var modalEditar = document.getElementById('modalEditar');
	if (modalEditar) {
		modalEditar.addEventListener('show.bs.modal', function() {
			syncHiddenFieldsEdit();
		});
	}
	// Sincronizar SIEMPRE justo antes de enviar el formulario de edición
	var formEdit = document.getElementById('formEditar');
	if (formEdit) {
		formEdit.addEventListener('submit', function(e) {
			syncHiddenFieldsEdit();
		}, true);
	}
});
</script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>