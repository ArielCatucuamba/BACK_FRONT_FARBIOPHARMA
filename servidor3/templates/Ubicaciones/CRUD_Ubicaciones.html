<!DOCTYPE html>
<html lang="es">

<head>
	<style>
		/* Consistent column widths for la tabla de Ubicaciones */
		.table-fixed {
			table-layout: fixed;
			width: 100%;
		}
		.table-fixed th,
		.table-fixed td {
			overflow: hidden;
			word-break: break-word;
		}
		/* 1: ID */
		.table-fixed th:nth-child(1),
		.table-fixed td:nth-child(1) {
			min-width: 80px;
			width: 80px;
		}
		/* 2: Ubicación */
		.table-fixed th:nth-child(2),
		.table-fixed td:nth-child(2) {
			min-width: 200px;
			width: 200px;
		}
		/* 3: Geolocalización (reducida) */
		.table-fixed th:nth-child(3),
		.table-fixed td:nth-child(3) {
			min-width: 160px;
			width: 160px;
		}
		/* 4: Dirección (ampliada) */
		.table-fixed th:nth-child(4),
		.table-fixed td:nth-child(4) {
			min-width: 400px;
			width: 400px;
		}
		/* 5: Acciones (reducida) */
		.table-fixed th:nth-child(5),
		.table-fixed td:nth-child(5) {
			min-width: 80px;
			width: 80px;
		}
	</style>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CRUD Ubicaciones</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- (Se eliminó el CSS duplicado anterior) -->
	<style>
		.table thead th {
			background: #0d3b4e;
			color: #fff;
		}

		.table tbody tr:nth-child(even) {
			background: #f2f6fa;
		}

		.btn-action {
			margin-right: 4px;
		}

		.search-box {
			max-width: 300px;
		}
	</style>
</head>

<body>

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">Ubicaciones</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Bienvenido, {{ session.username }}</span>
                <a class="nav-link" href="{{ url_for('logout') }}">Cerrar Sesión</a>
            </div>
        </div>
    </nav>

		<div class="container mt-5">
			<!-- Mensaje de error de validación (JS) -->
			<div id="mensajeError" style="display:none;" class="alert alert-danger alert-dismissible fade show" role="alert">
				<span id="textoMensajeError"></span>
				<button type="button" class="btn-close" onclick="cerrarMensajeError()" aria-label="Close"></button>
			</div>
			{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
					{% for category, message in messages %}
						<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
							{{ message }}
							<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
						</div>
					{% endfor %}
				{% endif %}
			{% endwith %}

		<!-- Encabezado mejorado: título y debajo una fila con Regresar, filtro y Agregar -->
		<div class="mb-2">
			<h2 class="mb-3">Gestión de Ubicaciones</h2>
			<div class="row g-2 align-items-center">
				<div class="col-auto">
					<a href="/menu" class="btn btn-secondary">&larr; Regresar al menú</a>
				</div>
				<div class="col">
					<input type="text" id="filtroDescripcion" class="form-control" placeholder="Filtrar por Ubicación" autocomplete="off">
					<datalist id="listaDescripciones">
						<option value="Oficinas Centrales">Oficinas Centrales</option>
						<option value="Planta Central">Planta Central</option>
						<option value="Oyambarillo">Oyambarillo</option>
						<option value="El Carmen">El Carmen</option>
					</datalist>
				</div>
				<div class="col-auto">
					<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAgregar">+ Nueva ubicación</button>
				</div>
			</div>
		</div>
		<!-- Modal para editar departamento -->
		<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form id="formEditar" method="POST">
						<div class="modal-header">
							<h5 class="modal-title" id="modalEditarLabel">Editar Ubicación</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id" id="editarId">
							<div class="mb-3">
								<label for="editarDescripcion" class="form-label">Descripción</label>
								<input type="text" class="form-control" name="descripcion" id="editarDescripcion"
									required>
							</div>
							<div class="mb-3">
								<label for="editarGeolocalizacion" class="form-label">Geolocalización</label>
								<input type="text" class="form-control" name="geolocalizacion"
									id="editarGeolocalizacion" required>
							</div>
							<div class="mb-3">
								<label for="editarDireccion" class="form-label">Dirección</label>
								<input type="text" class="form-control" name="direccion" id="editarDireccion" required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Guardar cambios</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Modales reubicados para compatibilidad Bootstrap -->
		<!-- Modal para agregar departamento -->
		<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form method="POST" action="{{ url_for('ubicaciones') }}">
						<div class="modal-header">
							<h5 class="modal-title" id="modalAgregarLabel">Agregar Ubicación</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="mb-3">
								<label for="nuevaDescripcion" class="form-label">Descripción</label>
								<select class="form-select" name="descripcion" id="nuevaDescripcion" required>
									<option value="">Seleccione una opción</option>
									<option value="Oficinas Centrales">Oficinas Centrales</option>
									<option value="Planta Central">Planta Central</option>
									<option value="Oyambarillo">Oyambarillo</option>
									<option value="El Carmen">El Carmen</option>
								</select>
							</div>
							<div class="mb-3">
								<label for="nuevaGeolocalizacion" class="form-label">Geolocalización</label>
								<input type="text" class="form-control" name="geolocalizacion" id="nuevaGeolocalizacion"
									required>
							</div>
							<div class="mb-3">
								<label for="nuevaDireccion" class="form-label">Dirección</label>
								<input type="text" class="form-control" name="direccion" id="nuevaDireccion" required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Agregar</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<!-- Modal para editar departamento -->
		<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<form id="formEditar" method="POST">
						<div class="modal-header">
							<h5 class="modal-title" id="modalEditarLabel">Editar Departamento</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" name="id" id="editarId">
							<div class="mb-3">
								<label for="editarDepartamento" class="form-label">Departamento</label>
								<input type="text" class="form-control" name="departamento" id="editarDepartamento"
									required>
							</div>
							<div class="mb-3">
								<label for="editarDescripcion" class="form-label">Ubicación</label>
								<input type="text" class="form-control" name="descripcion" id="editarDescripcion"
									required>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="submit" class="btn btn-primary">Guardar cambios</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<table class="table table-bordered table-fixed" id="tablaUbicaciones">
			<thead>
				<tr>
					<th>ID</th>
					<th>Ubicación</th>
					<th>Geolocalización</th>
					<th>Dirección</th>
					<th>Acciones</th>
				</tr>
			</thead>
			<tbody>
				{% for ubi in ubicaciones %}
				<tr>
					<td>{{ ubi[0] }}</td>
					<td class="ubicacion-descripcion">{{ ubi[1] }}</td>
					<td>{{ ubi[2] }}</td>
					<td>{{ ubi[3] }}</td>
					<td>
						<button type="button" class="btn btn-sm btn-primary btn-action" title="Editar"
							data-bs-toggle="modal" data-bs-target="#modalEditar" data-id="{{ ubi[0] }}"
							data-descripcion="{{ ubi[1]|e }}" data-geolocalizacion="{{ ubi[2]|e }}"
							data-direccion="{{ ubi[3]|e }}" onclick="llenarFormularioEditarDesdeBoton(this)">
							<i class="bi bi-pencil"></i>
						</button>
						<form method="POST" action="{{ url_for('eliminar_ubicacion', id=ubi[0]) }}" class="d-inline">
							<button type="submit" class="btn btn-sm btn-danger btn-action" title="Eliminar"><i
									class="bi bi-trash"></i></button>
						</form>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
	<script>
	function llenarFormularioEditarDesdeBoton(btn) {
		var id = btn.getAttribute('data-id');
		var descripcion = btn.getAttribute('data-descripcion');
		var geolocalizacion = btn.getAttribute('data-geolocalizacion');
		var direccion = btn.getAttribute('data-direccion');
		document.getElementById('formEditar').action = '/ubicaciones/editar/' + id;
		document.getElementById('editarId').value = id;
		document.getElementById('editarDescripcion').value = descripcion;
		document.getElementById('editarGeolocalizacion').value = geolocalizacion;
		document.getElementById('editarDireccion').value = direccion;
	}

	function soloNumeros(texto) {
		return /^\d+$/.test(texto.trim());
	}

	function mostrarMensajeError(mensaje) {
		var div = document.getElementById('mensajeError');
		var span = document.getElementById('textoMensajeError');
		span.textContent = mensaje;
		div.style.display = '';
		window.scrollTo({ top: 0, behavior: 'smooth' });
	}

	function cerrarMensajeError() {
		var div = document.getElementById('mensajeError');
		div.style.display = 'none';
	}

	// Validación para el formulario de agregar y editar
	document.addEventListener('DOMContentLoaded', function() {
		var formAgregar = document.querySelector("form[action='{{ url_for('ubicaciones') }}']");
		if (formAgregar) {
			formAgregar.addEventListener('submit', function(e) {
				var direccion = document.getElementById('nuevaDireccion').value;
				if (soloNumeros(direccion)) {
					e.preventDefault();
					mostrarMensajeError('La dirección no puede ser solo números.');
				}
			});
		}
		var formEditar = document.getElementById('formEditar');
		if (formEditar) {
			formEditar.addEventListener('submit', function(e) {
				var direccion = document.getElementById('editarDireccion').value;
				if (soloNumeros(direccion)) {
					e.preventDefault();
					mostrarMensajeError('La dirección no puede ser solo números.');
				}
			});
		}
	});

		// Filtrado incremental: coincidencia parcial y case-insensitive
		function filtrarPorDescripcion() {
			var valor = document.getElementById('filtroDescripcion').value.trim().toLowerCase();
			var tabla = document.getElementById('tablaUbicaciones');
			var filas = tabla.getElementsByTagName('tr');
			for (var i = 1; i < filas.length; i++) { // i=1 para saltar el encabezado
				var celda = filas[i].getElementsByClassName('ubicacion-descripcion')[0];
				if (celda) {
					var texto = celda.textContent.trim().toLowerCase();
					if (!valor || texto.includes(valor)) {
						filas[i].style.display = '';
					} else {
						filas[i].style.display = 'none';
					}
				}
			}
		}
		// Conectar input para filtrado en tiempo real
		document.addEventListener('DOMContentLoaded', function() {
			var inputFiltro = document.getElementById('filtroDescripcion');
			if (inputFiltro) {
				inputFiltro.setAttribute('list', 'listaDescripciones');
				inputFiltro.addEventListener('input', filtrarPorDescripcion);
			}
		});
	</script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>